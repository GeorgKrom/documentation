---
sidebar_position: 10
---
# Usage with Next.js

It's possible to implement FSD in a Next.js project, but conflicts arise due to differences between Next.js project structure requirements and FSD principles.

## Conflict between FSD and Next.js in the `app` layer

Next.js suggests using the `app` folder to define application routes. It expects files in the `app` folder to correspond to pathnames.
This routing mechanism **does not align** with the FSD concept, as it's not possible to maintain a flat slice structure with such a routing mechanism.

The approach is to move the Next.js `app` folder to the project root and import FSD pages into the Next.js `app` folder.
This preserves the FSD project structure inside the `src` folder, where layer folders should be placed.

You should also add a `pages` folder to the project root because App Router is compatible with Pages Router.
The best way is to put `README.md` files inside the root `pages` folder describing why it is necessary but empty.

```sh
├── app                              # App folder (Next.js)
│   ├── api
│   │   └── get-example
│   │       └── route.ts
│   └── example
│       └── page.tsx
├── pages                            # Legacy pages folder (Next.js)
│   └── README.md                    # To maintain compatibility with Pages Router
└── src
    ├── app
    ├── pages
    │   └── example
    │       ├── index.ts
    │       ├── ui
    │       │   └── example.tsx
    │       └── routes
    │           └── get-example.ts   # Route handler
    ├── widgets
    ├── features
    ├── entities
    └── shared
```

### Example of re-exporting a page from `src/pages/example` to `app/example/page.tsx`

```tsx title="app/example/page.tsx"
export { Example as default, metadata } from '@/pages/example';
```

### Middleware
If you use middleware in your project, it must be located in the project root alongside the `app` and `pages` folders.

### Instrumentation
The `instrumentation.ts|js` file allows you to monitor the performance and behavior of your application. If you use it, it must be located in the project root, similar to `middleware.ts|js`.

### Route Handlers
It is suggested to use a new `api-routes` segment in the `app` layer to work with Route Handlers.
However, you should avoid overusing them due to code maintenance complexity and violation of separation of concerns principles.

```tsx title="src/app/api-routes/get-example-data.ts"
    import { getExamplesList } from '@/shared/db';

    export const getExampleData = () => {
        try {
            const examplesList = getExamplesList();

            return Response.json({ examplesList });
        } catch {
            return Response.json(null, {
                status: 500,
                statusText: 'Ouch, something went wrong',
            });
        }
    };
```

```tsx title="app/api/example/route.ts"
export { getExampleData as GET } from '@/app';
```

### Additional recommendations
- Use the `db` segment in the `shared` layer to describe database queries and their further use in higher layers.
- Caching and revalidating queries logic is better kept in the same place as the queries themselves.

## Legacy approach with Pages Router
When using the Pages Router, routes should be placed in the `pages` folder in the root of the project, similar to `app` for the App Router.
The structure inside `src` where the layer folders are located remains unchanged.

```sh
├── pages                        # Pages folder (Next.js)
│   ├── _app.tsx
│   ├── api
│   │   └── example.ts           # API Route re-export
│   └── example
│       └── index.tsx
└── src
    ├── app
    │   └── custom-app
    │       └── custom-app.tsx   # Custom App component
    ├── pages
    │   └── example
    │       ├── index.ts
    │       ├── ui
    │       │   └── example.tsx
    │       └── routes
    │           ├── config.ts    # API Route config
    │           └── handler.ts   # API Route
    ├── widgets
    ├── features
    ├── entities
    └── shared
```

### Custom `_app` component

You can place your Custom App component in `src/app/_app` or `src/app/custom-app`

```tsx title="src/app/custom-app/custom-app.tsx"
import type { AppProps } from 'next/app';

export const MyApp = ({ Component, pageProps }: AppProps) => {
    return (
        <>
            <p>My Custom App component</p>
            <Component { ...pageProps } />
        </>
    );
};
```

```tsx title="pages/_app.tsx"
export { App as default } from '@/app';
```

Example of re-exporting a page from `src/pages/example` to `pages/example/index.tsx`:

```tsx title="pages/example/index.tsx"
export { Example as default } from '@/pages/example';
```

### API Routes
It is suggested to use a new `api-routes` segment in the `app` layer to work with API Routes.

```tsx title="app/api/example.ts"
export { handler as default, config } from '@/app';
```

## See also

[Next.js Project Structure](https://Next.js.org/docs/app/getting-started/project-structure)
[Next.js Page Layouts](https://Next.js.org/docs/app/getting-started/layouts-and-pages)

[project-knowledge]: /docs/about/understanding/knowledge-types
[ext-app-router-stackblitz]: https://stackblitz.com/edit/stackblitz-starters-aiez55?file=README.md